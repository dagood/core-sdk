<Project>

  <!-- TODO: Move this file (implementing source-build targets) to Arcade. -->

  <!--
    This file is separate because it's brand new (not adapted from dotnet/source-build) and specific
    to injecting source-build into Arcade's build process.
  -->

  <PropertyGroup>
    <SourceBuildEngineeringDir>$([MSBuild]::NormalizeDirectory('$(RepositoryEngineeringDir)', 'source-build'))</SourceBuildEngineeringDir>
    <SourceBuildArtifactsDir>$([MSBuild]::NormalizeDirectory('$(ArtifactsDir)', 'source-build'))</SourceBuildArtifactsDir>
    <CurrentRepoSourceBuildArtifactsDir>$([MSBuild]::NormalizeDirectory('$(ArtifactsDir)', 'source-build', 'repo'))</CurrentRepoSourceBuildArtifactsDir>

    <ToolsLocalDir>$(SourceBuildEngineeringDir)tools-local/</ToolsLocalDir>
    <TaskDir>$(ToolsLocalDir)tasks/</TaskDir>
    <XPlatTasksBinDir>$(TaskDir)Microsoft.DotNet.SourceBuild.Tasks.XPlat/bin/$(Configuration)/netstandard2.0/</XPlatTasksBinDir>
    <XPlatSourceBuildTasksAssembly>$(XPlatTasksBinDir)Microsoft.DotNet.SourceBuild.Tasks.XPlat.dll</XPlatSourceBuildTasksAssembly>

    <LocalNuGetPackagesRoot>$([MSBuild]::NormalizeDirectory('$(CurrentRepoSourceBuildArtifactsDir)', '.packages'))</LocalNuGetPackagesRoot>

    <DotNetCliToolDir>$([MSBuild]::NormalizeDirectory('$(DotNetRoot)'))</DotNetCliToolDir>
  </PropertyGroup>

  <Target Name="BuildUpstreamRepos"
          Condition="
            '$(FromSource)' == 'true' and
            '$(InnerBuildFromSource)' != 'true' and
            '$(BuildUpstreamRepos)' == 'true'"
          BeforeTargets="Execute">
    <ItemGroup>
      <RepositoryReference Include="aspnetcore" />
      <RepositoryReference Include="newtonsoft-json" />
      <RepositoryReference Include="newtonsoft-json901" />
      <RepositoryReference Include="toolset" />
    </ItemGroup>

    <MSBuild
      Projects="$(RepoRoot)eng\source-build\build.proj"
      Targets="PrepareOutput;InitBuild"
      Properties="RepoRoot=$(RepoRoot)" />

    <MSBuild
      Projects="@(RepositoryReference -> '$(RepoRoot)eng\source-build\repos\%(Identity).proj')"
      Properties="RepoRoot=$(RepoRoot)"
      StopOnFirstFailure="true" />
  </Target>

  <Target Name="DownloadTarballPackages">
    <MSBuild
      Projects="$(RepoRoot)eng\source-build\build.proj"
      Targets="
        DownloadSourceBuildReferencePackages;
        DownloadSourceBuiltArtifacts" />
  </Target>

  <Target Name="RunCopyAndDisassembleReferenceOnlyPackages">
    <MSBuild
      Projects="$(RepoRoot)eng\source-build\build.proj"
      Targets="CopyAndDisassembleReferenceOnlyPackages"
      Properties="ArchiveDownloadedPackages=true" />
  </Target>

  <Target Name="ExecuteWithSourceBuiltTooling"
          DependsOnTargets="
            BuildUpstreamRepos;
            GetSourceBuildCommandConfiguration;
            ExecuteInnerSourceBuild;
            PackSourceBuildIntermediateNupkg;
            PackSourceBuildTarball"
          Condition="
            '$(FromSource)' == 'true' and
            '$(InnerBuildFromSource)' != 'true'"
          BeforeTargets="Execute" />
  
  <!--
    Separate target to execute to provide easy hook point for BeforeTargets that will only trigger
    when the inner build is actually happening. Hooking BeforeTargets on
    ExecuteWithSourceBuiltTooling runs unconditionally, for example, inside the core-sdk build.
  -->
  <Target Name="ExecuteInnerSourceBuild">
    <PropertyGroup>
      <PreventPrebuiltBuild>true</PreventPrebuiltBuild>
      <InnerBuildArgs>$(InnerBuildArgs) /p:InnerBuildFromSource=true</InnerBuildArgs>
    </PropertyGroup>

    <Exec
      Condition="'$(ExecuteInnerSourceBuild)' != 'false'"
      Command="$(REPO_BUILD_TOOL_COMMAND) $(InnerBuildArgs)"
      WorkingDirectory="$(ProjectDirectory)"
      EnvironmentVariables="@(InnerBuildEnv)"
      IgnoreStandardErrorWarningFormat="true" />
  </Target>

  <!--
    TODO: Combine with SBRP work. Included here to make merge conflict resolution in the
    DependsOnTargets more obvious.
  -->
  <Target Name="PackSourceBuildIntermediateNupkg" />

  <Target Name="PreventPrebuiltBuild"
          DependsOnTargets="ExecuteWithSourceBuiltTooling"
          Condition="'$(PreventPrebuiltBuild)' == 'true'"
          BeforeTargets="Execute">
    <ItemGroup>
      <ProjectToBuild Remove="@(ProjectToBuild)" />
      <ProjectToBuild Include="$(MSBuildThisFileDirectory)Noop.proj" />
    </ItemGroup>
  </Target>

</Project>
